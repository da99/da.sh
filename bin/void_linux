#!/usr/bin/env zsh
#
#
set -u -e -o pipefail

case "$@" in
  -h|--help|help)
    cmd="$(basename "$0")"
    echo "  $cmd hud available packages"
    echo "  $cmd [list|install] packages [devel]"
    echo "  $cmd upgrade packages"
    echo "  $cmd upgrade void-packages"
    echo "     Updates /progs/void-packages"
    echo "  $cmd cleanup"
    echo "  $cmd install time"
    echo "       Installs and activates the chrony service"
    ;;

  setup)
    if rg "options btusb enable_autosuspend=0" /etc/modprobe.d >/dev/null ; then
      echo "--- Bluetooth auto-suspend has been disable." >&2
    else
      echo "!!! Disable Bluetooth auto-suspend." >&2
      echo "echo \"options btusb enable_autosuspend=0\" | sudo tee /etc/modprobe.d/disable_btusb-autosuspend.conf" >&2
      exit 1
    fi
    ;;

  "install time")
    if test -e /var/service/openntpd ; then
      echo "!!! REMOVE openntpd first." >&2
      exit 1
    fi
    which chronyd || sudo xbps-install -S chrony
    if test -e /var/service/chronyd ; then
      echo "--- Chronyd already installed" >&2
      exit 0;
    fi
    sudo ln -s /etc/sv/chronyd /var/service/
    stat /var/service/chronyd
    ;;

  "list packages")
    if command -v xbps-install >/dev/null; then
      cd "$(dirname "$0")"/..
      cat config/void.packages.txt | tr '\n' ' '
    else
      lsb_release -a
      exit 1
    fi
    ;;

  "list packages devel")
    if command -v xbps-install >/dev/null; then
      cd "$(dirname "$0")"/..
      cat config/void.packages.devel.txt | tr '\n' ' '
    else
      lsb_release -a
      exit 1
    fi
    ;;

  "install packages")
    cd "$(dirname "$0")"/..
    set -x
    sudo xbps-install -S $("$0" list packages | tr '\n' ' ')
    ;;

  "install packages devel")
    cd "$(dirname "$0")"/..
    set -x
    sudo xbps-install -S $("$0" list packages devel | tr '\n' ' ')
    ;;

  "upgrade void-packages")
    set -x
    cd /progs/void-packages
    # git pull
    # https://github.com/void-linux/void-packages
    # xcheckmypkgs
    # ./xbps-src show-sys-updates
    ./xbps-src show-local-updates
    ./xbps-src update-check nmap
    ./xbps-src update-check google-chrome
    ;;

  "upgrade packages")
    set -x
    sudo xbps-install -u xbps
    sudo xbps-install -Su
    ;;

  "cleanup")
    set -x
    sudo xbps-remove -Oo
    xbps-remove -yO
    sudo xbps-remove -yo
    "$0" cleanup /boot/efi
    ;;

  "cleanup /boot/efi")
    df_usage="$(df | grep --color=never "% /boot/efi" || : )"
    if test -z "$df_usage" ; then
      echo "--- Skipping cleaning /boot/efi. Not found." >&2
      exit 0
    fi
    efi_usage="$(echo "$df_usage" | tr -s ' ' | cut -d' ' -f5 | tr -d '%')"
    cd /var/log
    if test -f Xorg.0.log.old ; then
      sudo rm Xorg.0.log.old
    fi
    if test "$efi_usage" -gt 45 ; then
      sudo vkpurge rm all
    else
      set +x
      echo "--- Skipping vkpurge because /boot/efi is at ${efi_usage}% used."
    fi
    set +x
    ;;

  "hud available packages")
    count="$(xbps-install -Mun | wc -l)"
    if test "$count" = "0" ; then
      echo
    else
      echo "New packages: $count"
    fi
    ;;

  *)
    echo "!!! Unknown options: $@" >&2
    exit 1
    ;;
esac

